<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Dashboard</title>

    <!-- Favicon & PWA -->
    <link rel="icon" type="image/svg+xml" href="./assets/favicon-BfPjT8xF.svg">
    <link rel="icon" type="image/png" href="./assets/favicon-CIKpfr-F.png">
    <link rel="manifest" href="./assets/manifest-C9L6--Yd.json">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons & Charts -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/apexcharts@3.35.0/dist/apexcharts.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/analytics.css">
  <script type="module" crossorigin src="./assets/vendor-bootstrap-mtNt7MV9.js"></script>
  <script type="module" crossorigin src="./assets/vendor-charts-mx47zOnq.js"></script>
  <script type="module" crossorigin src="./assets/vendor-ui-DwtnxsuI.js"></script>
  <script type="module" crossorigin src="./assets/main-C46tBrlN.js"></script>
  <link rel="stylesheet" crossorigin href="./assets/main-DyLKuzVJ.css">
</head>

<body data-page="analytics" class="analytics-page vietnamese-content">
    <div class="admin-app">
        <div class="admin-wrapper" id="admin-wrapper">

            <!-- Header -->
            <header class="admin-header">
                <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
                    <div class="container-fluid">
                        <a class="navbar-brand d-flex align-items-center" href="./index.html">
                            <img src="./assets/logo-_bzzc8PV.svg" alt="Logo" height="32" class="me-2">
                            <h1 class="h4 mb-0 fw-bold text-primary">4Foods</h1>
                        </a>
                        <div class="search-container flex-grow-1 mx-4">
                            <div class="position-relative">
                                <input type="search" class="form-control" placeholder="Search... (Ctrl+K)">
                                <i class="bi bi-search position-absolute top-50 end-0 translate-middle-y me-3"></i>
                            </div>
                        </div>
                        <div class="navbar-nav flex-row">
                            <button class="btn btn-outline-secondary me-2" type="button" title="Toggle theme"><i class="bi bi-sun-fill"></i></button>
                            <button class="btn btn-outline-secondary me-2" type="button" data-fullscreen-toggle title="Toggle fullscreen"><i class="bi bi-arrows-fullscreen"></i></button>
                            <div class="dropdown me-2">
                                <button class="btn btn-outline-secondary position-relative" type="button" data-bs-toggle="dropdown">
                                    <i class="bi bi-bell"></i>
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">3</span>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><h6 class="dropdown-header">Notifications</h6></li>
                                    <li><a class="dropdown-item" href="#">New user registered</a></li>
                                    <li><a class="dropdown-item" href="#">Server status update</a></li>
                                    <li><a class="dropdown-item" href="#">New message received</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-center" href="#">View all notifications</a></li>
                                </ul>
                            </div>
                            <div class="dropdown">
                                <button class="btn btn-outline-secondary d-flex align-items-center" type="button" data-bs-toggle="dropdown">
                                    <img src="data:image/svg+xml,%3csvg%20width='32'%20height='32'%20viewBox='0%200%2032%2032'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3c!--%20Background%20circle%20--%3e%3ccircle%20cx='16'%20cy='16'%20r='16'%20fill='url(%23avatarGradient)'/%3e%3c!--%20Person%20silhouette%20--%3e%3cg%20fill='white'%20opacity='0.9'%3e%3c!--%20Head%20--%3e%3ccircle%20cx='16'%20cy='12'%20r='5'/%3e%3c!--%20Body%20--%3e%3cpath%20d='M16%2018c-5.5%200-10%202.5-10%207v1h20v-1c0-4.5-4.5-7-10-7z'/%3e%3c/g%3e%3c!--%20Subtle%20border%20--%3e%3ccircle%20cx='16'%20cy='16'%20r='15.5'%20fill='none'%20stroke='rgba(255,255,255,0.2)'%20stroke-width='1'/%3e%3c!--%20Gradient%20definition%20--%3e%3cdefs%3e%3clinearGradient%20id='avatarGradient'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20style='stop-color:%236b7280;stop-opacity:1'%20/%3e%3cstop%20offset='100%25'%20style='stop-color:%234b5563;stop-opacity:1'%20/%3e%3c/linearGradient%3e%3c/defs%3e%3c/svg%3e" width="24" height="24" class="rounded-circle me-2">
                                    <span class="d-none d-md-inline">John Doe</span>
                                    <i class="bi bi-chevron-down ms-1"></i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Profile</a></li>
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-gear me-2"></i>Settings</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#"><i class="bi bi-box-arrow-right me-2"></i>Logout</a></li>
                                </ul>
                            </div>
                        </div>
                        </div>
                    </div>
                </nav>
            </header>

            <!-- Sidebar -->
            <aside class="admin-sidebar" id="admin-sidebar">
                <div class="sidebar-content">
                    <nav class="sidebar-nav">
                        <ul class="nav flex-column">
                            <li class="nav-item"><a class="nav-link" href="./index.html"><i class="bi bi-speedometer2"></i> Dashboard</a></li>
                            <li class="nav-item"><a class="nav-link active" href="./analytics.html"><i class="bi bi-graph-up"></i> Analytics <span class="badge bg-primary rounded-pill ms-auto">Active</span></a></li>
                            <li class="nav-item"><a class="nav-link" href="./users.html"><i class="bi bi-people"></i> Users</a></li>
                            <li class="nav-item"><a class="nav-link" href="./products.html"><i class="bi bi-box"></i> Products</a></li>
                            <li class="nav-item"><a class="nav-link" href="./orders.html"><i class="bi bi-bag-check"></i> Orders</a></li>
                            <li class="nav-item"><a class="nav-link" href="./calendar.html"><i class="bi bi-calendar-event"></i> Calendar</a></li>
                            <li class="nav-item mt-3"><small class="text-muted px-3 text-uppercase fw-bold">Admin</small></li>
                            <li class="nav-item"><a class="nav-link" href="./settings.html"><i class="bi bi-gear"></i> Settings</a></li>
                        </ul>
                    </nav>
                </div>
            </aside>

            <button class="hamburger-menu" type="button" data-sidebar-toggle><i class="bi bi-list"></i></button>

            <!-- Main Content -->
            <main class="admin-main">
                <div class="container-fluid p-4 p-lg-5">

                    <div class="d-flex justify-content-between align-items-center mb-4 mb-lg-5">
                        <div>
                            <h1 class="h3 mb-0">Analytics Dashboard</h1>
                            <p class="text-muted mb-0">Comprehensive insights and performance metrics</p>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm">
                            <i class="bi bi-download me-2"></i>Export Report
                        </button>
                    </div>

                    <!-- TOÀN BỘ NỘI DUNG ĐỘNG -->
                    <div x-data="analyticsComponent" x-init="init()">

                        <!-- 1. Biểu đồ doanh thu 30 ngày gần nhất -->
                        <div class="row g-4 mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">DOANH THU 30 NGÀY GẦN NHẤT</h5>
                                    </div>
                                    <div class="card-body">
                                        <div id="revenueChart" style="height: 350px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 2. Tổng doanh thu -->
                        <div class="row g-4 mb-4">
                            <div class="col-12">
                                <div class="card revenue-summary">
                                    <div class="card-header"><h5 class="card-title mb-0">TỔNG DOANH THU</h5></div>
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="display-4 fw-bold" x-text="formatCurrency(totalRevenue)"></div>
                                            <div class="ms-3">
                                                <div class="text-success small">Từ trước đến nay</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 3. Doanh thu hôm nay + tăng trưởng -->
                        <div class="row g-4 mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <h5 class="card-title mb-0">DOANH THU THEO THỜI GIAN</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-md-3 p-3">
                                                <div class="text-muted small">Hôm nay</div>
                                                <div class="h4 fw-bold mt-2" x-text="formatCurrency(todayRevenue)"></div>
                                                <div class="small mt-1" :class="growth >= 0 ? 'text-success' : 'text-danger'"
                                                     x-text="(growth > 0 ? '+' : '') + growth.toFixed(1) + '%'"></div>
                                            </div>
                                            <div class="col-md-3 p-3">
                                                <div class="text-muted small">Tuần này</div>
                                                <div class="h4 fw-bold mt-2">$18,745.00</div>
                                                <div class="text-success small mt-1">+8.2%</div>
                                            </div>
                                            <div class="col-md-3 p-3">
                                                <div class="text-muted small">Tháng này</div>
                                                <div class="h4 fw-bold mt-2">$45,672.30</div>
                                                <div class="text-success small mt-1">+15.3%</div>
                                            </div>
                                            <div class="col-md-3 p-3">
                                                <div class="text-muted small">Năm nay</div>
                                                <div class="h4 fw-bold mt-2">$89,124.75</div>
                                                <div class="text-success small mt-1">+22.7%</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 4. Đơn hàng mới nhất -->
                        <div class="row g-4 mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="card-title mb-0">ĐƠN HÀNG MỚI NHẤT</h5>
                                        <a href="/orders.html" class="btn btn-sm btn-outline-primary">Xem tất cả</a>
                                    </div>
                                    <div class="card-body p-0">
                                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                            <table class="table table-hover mb-0">
                                                <thead class="table-light sticky-top">
                                                    <tr>
                                                        <th>Mã đơn</th>
                                                        <th>Khách hàng</th>
                                                        <th>Ngày đặt</th>
                                                        <th>Sản phẩm</th>
                                                        <th>Tổng tiền</th>
                                                        <th>Trạng thái</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <template x-for="order in recentOrders" :key="order._id">
                                                        <tr>
                                                            <td class="fw-bold" x-text="'#ORD-' + order._id.slice(-6).toUpperCase()"></td>
                                                            <td x-text="order.user?.name || 'Khách lẻ'"></td>
                                                            <td x-text="new Date(order.createdAt).toLocaleDateString('vi-VN')"></td>
                                                            <td x-text="order.items.length + ' sản phẩm'"></td>
                                                            <td class="fw-bold text-primary" x-text="formatCurrency(order.total)"></td>
                                                            <td>
                                                                <span class="badge"
                                                                      :class="{
                                                                        'bg-success': order.status === 'delivered',
                                                                        'bg-warning': ['processing','shipping','arrived'].includes(order.status),
                                                                        'bg-danger': order.status === 'cancelled',
                                                                        'bg-info': order.status === 'refund_pending'
                                                                      }"
                                                                      x-text="{
                                                                        delivered: 'Hoàn thành',
                                                                        processing: 'Đang xử lý',
                                                                        shipping: 'Đang giao',
                                                                        arrived: 'Đã đến',
                                                                        cancelled: 'Đã hủy',
                                                                        refund_pending: 'Hoàn tiền'
                                                                      }[order.status] || order.status"></span>
                                                            </td>
                                                        </tr>
                                                    </template>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 5. Phương thức thanh toán -->
                        <div class="row g-4 mb-4">
                            <div class="col-md-6">
                                <div class="card h-100 payment-method-card">
                                    <div class="card-header"><h5 class="card-title mb-0">THANH TOÁN TIỀN MẶT</h5></div>
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="display-5 fw-bold text-success" x-text="formatCurrency(paymentBreakdown.cod)"></div>
                                            <div class="ms-3">
                                                <div class="text-muted small">Tổng doanh thu</div>
                                                <div class="text-success small" x-text="formatPercentage((paymentBreakdown.cod/totalRevenue)*100) + ' tổng doanh thu'"></div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <div class="progress progress-custom">
                                                <div class="progress-bar bg-success" :style="{ width: (paymentBreakdown.cod/totalRevenue*100 || 0) + '%' }"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100 payment-method-card">
                                    <div class="card-header"><h5 class="card-title mb-0">THANH TOÁN CHUYỂN KHOẢN</h5></div>
                                    <div class="card-body">
                                        <div class="d-flex align-items-center">
                                            <div class="display-5 fw-bold text-primary" x-text="formatCurrency(paymentBreakdown.momo)"></div>
                                            <div class="ms-3">
                                                <div class="text-muted small">Tổng doanh thu</div>
                                                <div class="text-success small" x-text="formatPercentage((paymentBreakdown.momo/totalRevenue)*100) + ' tổng doanh thu'"></div>
                                            </div>
                                        </div>
                                        <div class="mt-3">
                                            <div class="progress progress-custom">
                                                <div class="progress-bar bg-primary" :style="{ width: (paymentBreakdown.momo/totalRevenue*100 || 0) + '%' }"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 6. Doanh thu theo danh mục -->
                        <div class="row g-4 mb-4">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header"><h5 class="card-title mb-0">DOANH THU THEO DANH MỤC</h5></div>
                                    <div class="card-body p-0">
                                        <div class="list-group list-group-flush">
                                            <template x-for="cat in topCategories" :key="cat._id">
                                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                                    <div class="d-flex align-items-center">
                                                        <div class="me-3 bg-primary bg-opacity-10 p-2 rounded">
                                                            <i class="bi bi-cup-straw text-primary"></i>
                                                        </div>
                                                        <div>
                                                            <div class="fw-medium" x-text="cat._id || 'Chưa xác định'"></div>
                                                            <small class="text-muted">Danh mục</small>
                                                        </div>
                                                    </div>
                                                    <div class="text-end">
                                                        <div class="h5 fw-bold mb-0" x-text="formatCurrency(cat.revenue)"></div>
                                                        <small class="text-success" x-text="formatPercentage((cat.revenue/totalRevenue)*100) + ' tổng doanh thu'"></small>
                                                    </div>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 7. Tổng kết hôm nay -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card revenue-summary">
                                    <div class="card-body text-center py-4">
                                        <h4 class="card-title mb-3">TỔNG KẾT DOANH THU HÔM NAY</h4>
                                        <div class="display-3 fw-bold mb-3" x-text="formatCurrency(todayRevenue)"></div>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="h5">Đơn hàng: <span x-text="todayOrders"></span></div>
                                                <small class="opacity-75">Trung bình <span x-text="formatCurrency(todayRevenue/todayOrders || 0) + '/đơn'"></span></small>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="h5">Khách hàng: <span x-text="todayCustomers"></span></div>
                                                <small class="opacity-75">Trung bình <span x-text="formatCurrency(todayRevenue/todayCustomers || 0) + '/khách'"></span></small>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="h5">Tăng trưởng: 
                                                    <span :class="growth >= 0 ? 'text-success' : 'text-danger'" 
                                                          x-text="(growth > 0 ? '+' : '') + growth.toFixed(1) + '%'"></span>
                                                </div>
                                                <small class="opacity-75">So với hôm qua</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div> <!-- End x-data -->
                </div>
            </main>
        </div>
    </div>

    <!-- Scripts - FIX HOÀN TOÀN LỖI ALPINE -->
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

    <!-- analytics.js phải load SAU Alpine -->
    <script src="/scripts/components/analytics.js"></script>

    <!-- main.js nếu có -->

    <!-- Sidebar toggle -->
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const btn = document.querySelector('[data-sidebar-toggle]');
        const wrapper = document.getElementById('admin-wrapper');
        if (btn && wrapper) {
            if (localStorage.getItem('sidebar-collapsed') === 'true') {
                wrapper.classList.add('sidebar-collapsed');
                btn.classList.add('is-active');
            }
            btn.addEventListener('click', () => {
                wrapper.classList.toggle('sidebar-collapsed');
                btn.classList.toggle('is-active');
                localStorage.setItem('sidebar-collapsed', wrapper.classList.contains('sidebar-collapsed'));
            });
        }
    });
    </script>
</body>
</html>